---
title: "Description of the OBI-water functions"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
bibliography: [packages.bib, water_funs_references.bib]
vignette: >
  %\VignetteIndexEntry{obi-water-functions}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = FALSE,
  comment = "#>"
)
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{r setup}
library(OBIC);library(ggplot2);library(data.table)
```

---
nocite: |
  @Groenendijk2016, @Tiktak2006, @CommissieDeskundigenMeststoffenwet2017, @Wosten2001
---

## Intorduction
The functions `calc_gw_recharge()`, `calc_n_efficiency()` and `calc_pestide_leaching()` were developed as part of a pilot study with the drinking water company Vitens and KWR. Vitens extracts a portion of its water from the groundwater. The aquifers used are protected by clay layers, but can be prone to pollution from above. Nitrogen and pesticide leaching are the most important forms of pollution originating from agriculture. Progress has been made in reducing the effects of these forms of pollution, nevertheless, additional steps have to be taken to ensure water quality in the future. On the other hand, ground water extraction can also negatively effect agricultural and natural areas as it can result in lowering of the ground water levels and drying of the area.

Soil characteristics determine the soils sensitivity for both leaching and drought to a great extent. As a result of intensive use the regulating functions may have been deteriorated which can have detrimental effects on ground water storage and availability in the future. Therefore, these functions were developed to facilitate the implementation of a soil strategy by drinking water companies. These functions will make it possible to compare soils in ground water protection areas with other regions. Also, they facilitate in the formulation of uniform target policies and assessments.



## Ground water recharge
The indicator score for groundwater recharge was calculated by using different indicator scores and correction factors. The indicator scores used are I_H_PSP for precipitation surplus, I_WRI_K for unsaturated permeability, and I_P_SE for soil sealing, These values give an indication of how much water infiltrates and how easily. The aggregate indicator value is corrected if the subsoil is compacted or if the field is drained. If the soil is compacted, the indicator score is reduced by 20% because it is harder for water to infiltrate and the water holding capacity will be lower. For groundwater levels IIIb and IV the indicator score will be reduced by 40% if the field is drained. In that case most of the water will be drained away to surface water. These correction factors are not applied simultaneously because it is assumed that drainage has a greater impact and compaction is less relevant if drainage is already in place. The calculation of the indicator score is according to the formula below. The precipitation surplus weighs most heavily because it contributes most to the actual recharge of groundwater.

(0.7 * I_H_PSP + 0.15 * I_WRI_K + 0.15 * I_P_SE) * cf_compaction/cf_drain


## Precipitation surplus and unsaturated permeability
The groundwater recharge function, `calc_gw_recharge()`, uses precipitation surplus and unsaturated permeability, among other factors. However, these factors were not yet calculated in the OBIC, so they were developed as helper functions. The function for precipitation surplus uses the long-term averages for precipitation and potential evaporation from the KNMI. Based on the cultivated crop and the application of catch crops the actual evaporation and the precipitation surplus is calculated. The figure below shows the logistic function for calculating the indicator score. A large proportion of crops can achieve a precipitation surplus around 400 mm. Since the annual average precipitation is 850 mm, we chose to assign an indicator score of 1 starting from a precipitation surplus of 400 mm. Thus, at this point, precipitation is proportionally distributed between the crop and groundwater. 
The OBIC already contains a function for saturated permeability, this was then converted to unsaturated permeability based on WÃ¶sten et al. (2001). The logistic function for calculating the indicator score can be found in the figure below.

```{r GW recharge, fig.width = 4,fig.height = 3, fig.align = 'center'}

  x = seq(0,600,10)
  y = OBIC::evaluate_logistic(x,0.05,300,2.5)
  y2 = OBIC::evaluate_logistic(x,0.04,130,1.5)
  
  scoring_range <- data.table(class = c("Very low","Low", "Average", "High","Very high"),
                              lower = c(0,0.25,0.5,0.75,1),
                              upper = c(0.25,0.5,0.75,1,1.25))
  
  ggplot() +
    theme_bw() +
    geom_rect(data = scoring_range,aes(xmin = 0, xmax = 600, ymin = lower, ymax = upper, fill = class), alpha = 0.4) +
    geom_line(aes(x,y), size = 1.2) +
    geom_line(aes(x,y2), size = 1.2) +
    scale_x_continuous(minor_breaks = c(0,100,200,300,400,500,600), breaks =  c(0,100,200,300,400,500,600)) +
    scale_y_continuous(limits = c(0,1.25), minor_breaks = c(0,0.25,0.5,0.75,1,1.25), breaks =  c(0,0.25,0.5,0.75,1,1.25)) +
    labs(x = "Precipitation surplus (mm)", y = "Index score" ) +
    scale_fill_manual(values = c("Very high" = "royalblue1","High" = "limegreen","Average"="yellow","Low"= "orange2", "Very low" = "tomato3"),
                      breaks = c("Very high","High", "Average", "Low","Very low"),
                      name = "")
  
  
  x = seq(0,200,10)
  y = evaluate_logistic(x,0.08,50,0.4)

  ggplot() +
    theme_bw() +
    geom_rect(data = scoring_range,aes(xmin = 0, xmax = 200, ymin = lower, ymax = upper, fill = class), alpha = 0.4) +
    geom_line(aes(x,y), size = 1.2) +
    scale_x_continuous(minor_breaks = c(0,50,100,150,200), breaks =  c(0,50,100,150,200)) +
    scale_y_continuous(limits = c(0,1.25), minor_breaks = c(0,0.25,0.5,0.75,1,1.25), breaks =  c(0,0.25,0.5,0.75,1,1.25)) +
    labs(x = "Unsaturated permeability (cm/d)", y = "Index score" ) +
    scale_fill_manual(values = c("Very high" = "royalblue1","High" = "limegreen","Average"="yellow","Low"= "orange2", "Very low" = "tomato3"),
                      breaks = c("Very high","High", "Average", "Low","Very low"),
                      name = "")

```



## Nitrogen use efficiency
The OBIC already contains a function for nitrogen leaching (in the form of nitrate), however, it only calculates leaching based on the nitrogen supply capacity of the soil. This new function calculates the nitrogen surplus from applied manure based on the nitrogen utilization of the crop. Based on the nitrogen surplus and leaching fractions determined for soil type, land use and groundwater level, the leaching to groundwater is calculated. The fractions of N surplus leaching to groundwater as nitrate (mg NO3 L-1 per kg N surplus) were calculated using the STONE modelling tool (Groenendijk et al. 2016). The calculated value for nitrogen leaching is used to calculate the indicator score. This function contains a variable for the fraction of the nitrogen application space that is utilized. This is because if the nitrogen supply capacity of the soil is high, less fertilization may be needed to meet the crop's needs. In addition, it is assumed that the nitrogen use efficiency is higher when P, K and pH are optimal, in this case nitrogen is the limiting factor. Therefore, with an indicator score of 0.9 for P, K and pH, the nitrogen surplus is reduced by 10%. The function further assumes an uptake of 75 kg N/ha by catch crops (Committee of Experts Fertilizer Act 2017). The logistic function for calculating the indicator score can be found below. Since the legally permitted concentration for nitrogen in groundwater is 50 mg NO3/L, it was chosen to give this concentration a score of 0. To encourage minimal nitrogen leaching, the score decreases sharply from a leaching rate of 20 mg NO3/L.


```{r N-efficiency, fig.width = 4,fig.height = 3, fig.align = 'center'}

  x = seq(0,50,1)
  y = ind_nretention(x,'gw')
  
  scoring_range <- data.table(class = c("Very low","Low", "Average", "High","Very high"),
                              lower = c(0,0.25,0.5,0.75,1),
                              upper = c(0.25,0.5,0.75,1,1.25))
  
  ggplot() +
    theme_bw() +
    geom_rect(data = scoring_range,aes(xmin = 0, xmax = 50, ymin = lower, ymax = upper, fill = class), alpha = 0.4) +
    geom_line(aes(x,y), size = 1.2) +
    scale_x_continuous(minor_breaks = c(0,10,20,30,40,50), breaks = c(0,10,20,30,40,50)) +
    scale_y_continuous(limits = c(0,1.25), minor_breaks = c(0,0.25,0.5,0.75,1,1.25), breaks =  c(0,0.25,0.5,0.75,1,1.25)) +
    labs(x = "Nitrogen leaching (mg NO3/L", y = "Index score" ) +
    scale_fill_manual(values = c("Very high" = "royalblue1","High" = "limegreen","Average"="yellow","Low"= "orange2", "Very low" = "tomato3"),
                      breaks = c("Very high","High","Average","Low","Very low"),
                      name = "")

```

## Pesticide leaching
The sensitivity of the soil to pesticide leaching is calculated using a meta-model of the leaching model PEARL, as described by Tiktak et al (2006). In this function, the fraction of a pesticide that leaches to a depth of 1 meter is calculated. This calculation is done with the properties of a highly persistent pesticide, thus a worst-case scenario is simulated. To make the assessment of different soils uniform, the leaching fraction is compared to a scenario with maximal leaching, namely at a minimal organic matter content. This minimal organic matter content is determined by taking the 0.001 quantile per soil type for all agricultural fields in the Netherlands. A relative score is calculated by dividing the current leaching fraction by the maximal leaching rate. If measures are taken to reduce the use of synthetic crop protection products such as the use of decision support systems or mechanical weed control, the leaching fraction for the current situation is reduced by 25%.
In a situation with an OM content of 3% and a precipitation surplus of 400 mm, the risk score for all soils except peaty clay is around 0.92. If the OS content is increased to 6% the score goes to a value of about 0.84. If measures are taken to use less pesticides these scores drop to values around 0.7 and 0.6 respectively. With an OS content of 15% and application of measures, the risk score further decreases to a value around 0.5. Therefore, it was decided to assign an index score of 0.75 to a risk score of 0.7 and to let the index score approach 1 at a risk score of 0.6. As the precipitation surplus decreases, the leaching fraction also decreases. As a result, a higher score can be achieved for the leaching of pesticides, but there is a trade-off for groundwater recharge, which will receive a lower score. Since a precipitation surplus of 400 mm has been labelled as optimal in the precipitation surplus function, this value has been used for the calibration of this indicator score.

```{r Pesticide leaching, fig.width = 4,fig.height = 3, fig.align = 'center'}

  x = seq(0,1,0.01)
  y = ind_pesticide_leaching(x)
  
  scoring_range <- data.table(class = c("Very low","Low", "Average", "High","Very high"),
                              lower = c(0,0.25,0.5,0.75,1),
                              upper = c(0.25,0.5,0.75,1,1.25))
  
  ggplot() +
    theme_bw() +
    geom_rect(data = scoring_range,aes(xmin = 0, xmax = 1, ymin = lower, ymax = upper, fill = class), alpha = 0.4) +
    geom_line(aes(x,y), size = 1.2) +
    scale_x_continuous(minor_breaks = c(0,0.25,0.5,0.75,1), breaks =  c(0,0.25,0.5,0.75,1)) +
    scale_y_continuous(limits = c(0,1.25), minor_breaks = c(0,0.25,0.5,0.75,1,1.25), breaks =  c(0,0.25,0.5,0.75,1,1.25)) +
    labs(x = "Leaching risk", y = "Index score" ) +
    scale_fill_manual(values = c("Very high" = "royalblue1","High" = "limegreen","Average"="yellow","Low"= "orange2", "Very low" = "tomato3"),
                      breaks = c("Very high","High","Average","Low","Very low"),
                      name = "")
  
```


```{r, include=FALSE}
knitr::write_bib(c(.packages()), "packages.bib")
knitr::write_bib(file = 'packages.bib')
```

# References
